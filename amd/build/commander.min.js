/**
 * JS to  the popup and interact with it.
 *
 *
 * Tested in Moodle 3.8
 *
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @copyright 2018 MFreak.nl
 * @author    Luuk Verhoeven
 **/
define("local_commander/commander",["jquery","core/notification","core/log"],(function($,notification,Log){$.fn.scrollTo=function(elem,speed){return $(this).stop().animate({scrollTop:$(this).scrollTop()-$(this).offset().top+$(elem).offset().top-10},null==speed?1e3:speed),this};var commanderAppOptions={courseid:"",keys:[]};const commanderApp={$mainModal:!1,$mainModalBackLayer:!1,$mainModalCommand:!1,$liSet:!1,isShow:!1,json:"",render:function(){var timer=0;Log.debug("render UI"),$("body").append('<div id="local_commander_modal" class="local_commander"><div class="local_commander-header"><h2>'+M.util.get_string("js:header","local_commander")+'</h2></div><div class="local_commander-body"></div><input type="text" name="local_commander_command" id="local_commander_command" placeholder="'+M.util.get_string("js:command_placeholder","local_commander")+'"></div><div id="local_commander_back_layer"></div>'),commanderApp.$mainModal=$("#local_commander_modal"),commanderApp.$mainModalBackLayer=$("#local_commander_back_layer"),commanderApp.$mainModalCommand=$("#local_commander_command"),commanderApp.setHeight(),commanderApp.$mainModalBackLayer.on("click",(function(){commanderApp.hide()})),commanderApp.$mainModalCommand.on("keydown",(function(e){var keyboardCode=e.keyCode||e.which;switch(Log.debug("Code pressed:"+keyboardCode),keyboardCode){case 27:case 13:case 38:case 40:return}Log.debug("Searching"),clearTimeout(timer),timer=setTimeout((function(){commanderApp.search(commanderApp.$mainModalCommand.val())}),100)})),""===commanderApp.json&&commanderApp.loadMenu()},start:function(){commanderApp.$mainModal=$("#local_commander_modal"),$(window).on("keydown",(function(e){var keyboardCode=e.keyCode||e.which;if(Log.debug("Code pressed:",keyboardCode),Log.debug("Trigger keys:",commanderAppOptions.keys),Log.debug("Commander is visible:",commanderApp.isShow),commanderApp.isShow)switch(keyboardCode){case 27:commanderApp.hide();break;case 13:e.preventDefault(),commanderApp.goToCommand();break;case 38:e.preventDefault(),commanderApp.arrowUp();break;case 40:e.preventDefault(),commanderApp.arrowDown()}else if(-1!==commanderAppOptions.keys.indexOf(keyboardCode.toString())){if(Log.debug("Commander keyboard key triggered"),"INPUT"==e.target.tagName||"SELECT"==e.target.tagName||"TEXTAREA"==e.target.tagName||e.target.isContentEditable)return void Log.debug("Hide when we are in an editable element");e.preventDefault(),0==commanderApp.$mainModal.length&&commanderApp.render(),Log.debug("Open commander."),commanderApp.isShow?commanderApp.hide():commanderApp.show()}}))},highlightWord:function(node,word){if(3==node.nodeType){var pos=node.data.toUpperCase().indexOf(word);if(pos>=0){var spannode=document.createElement("span");spannode.className="highlight",spannode.style.backgroundColor="#f4bd21";var middlebit=node.splitText(pos),middleclone=middlebit.cloneNode(!0);spannode.appendChild(middleclone),middlebit.parentNode.replaceChild(spannode,middlebit)}}else if(1==node.nodeType&&node.childNodes)for(var i=0;i<node.childNodes.length;++i)i+=commanderApp.highlightWord(node.childNodes[i],word)},arrowUp:function(){Log.debug("arrowUp");var $el=$("#local_commander_modal ul li.active"),$prev=$el.closest("li").prevAll("li:visible").eq(0);$el.length&&$el.removeClass("active"),$prev.length?$prev.addClass("active"):$el.addClass("active"),commanderApp.scrollTo()},arrowDown:function(){Log.debug("arrowDown");var $el=$("#local_commander_modal ul li.active"),$next=$el.closest("li").nextAll("li:visible").eq(0);$el.length&&$el.removeClass("active"),$next.length?$next.addClass("active"):$("#local_commander_modal ul li:visible").last().addClass("active"),commanderApp.scrollTo()},scrollTo:function(){$("#local_commander_modal .local_commander-body div").scrollTo("#local_commander_modal li.active",200)},goToCommand:function(){Log.debug("goToCommand");var $el=$("#local_commander_modal ul li.active a");if($el){var link=$el.attr("href");"#"!=link&&(window.location=link)}},loadMenu:function(){$.ajax({url:M.cfg.wwwroot+"/local/commander/ajax.php",method:"GET",data:{courseid:commanderAppOptions.courseid},dataType:"json"}).done((function(response){Log.debug(response),commanderApp.json=response,commanderApp.setMenu(),commanderApp.setHeight()})).fail((function(){notification.alert("js:error_parsing","local_commander")}))},search:function(word){$(".local_commander-body ul li").show(),commanderApp.$liSet.find("li.active").removeClass("active"),commanderApp.$liSet.find("span.highlight").each((function(){commanderApp.removeHighlight(this.parentNode)})),""!==word&&(commanderApp.$liSet.children().each((function(){commanderApp.highlightWord(this,word.toUpperCase())})),$(".local_commander-body span.highlight").first().parent().parent().addClass("active"),$(".local_commander-body ul li:not(:has(span))").hide())},setMenu:function(){Log.debug("setMenu() ");var html="<div><ul>";commanderAppOptions.courseid>0&&(Log.debug("Has course param."),html+=commanderApp.renderMenuItems(commanderApp.json.courseadmin,1)),html+=commanderApp.renderMenuItems(commanderApp.json.admin,1),html+="</ul></div>",commanderApp.$mainModal.find(".local_commander-body").append(html),commanderApp.$liSet=$(".local_commander-body ul")},renderMenuItems:function(child,depth,parentName){var html="";return child.name?(parentName?parentName+=" &rarr; ":parentName="",html+="<li>",child.name&&(html+='<a href="'+child.link+'">'+parentName+child.name+"</a>"),child.haschildren&&$.each(child.children,(function(i,el){html+=commanderApp.renderMenuItems(el,depth+1,parentName+child.name)})),html+="</li>"):html},show:function(){commanderApp.$mainModal.show(),commanderApp.$mainModalBackLayer.show(),commanderApp.isShow=!0,commanderApp.$mainModalCommand.focus()},hide:function(){commanderApp.$mainModal.hide(),commanderApp.$mainModalBackLayer.hide(),commanderApp.isShow=!1},setHeight:function(){var height=Math.round($(window).height()/2);commanderApp.$mainModal.height(height),$(".local_commander-body div").height(height-100)},removeHighlight:function(node){$(node).html($(node).text())}};return{init:function(params){!function(options){var key,vartype;for(key in commanderAppOptions)commanderAppOptions.hasOwnProperty(key)&&options.hasOwnProperty(key)&&(vartype=typeof commanderAppOptions[key],commanderAppOptions[key]="boolean"===vartype?Boolean(options[key]):"number"===vartype?Number(options[key]):"string"===vartype?String(options[key]):options[key])}(params),$(document).ready((function(){Log.debug("ready() - local commander v4.4"),Log.debug(commanderAppOptions),commanderApp.start()}))}}}));

//# sourceMappingURL=commander.min.js.map