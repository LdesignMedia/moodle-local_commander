define(["jquery","core/notification"],function(a,b){"use strict";var c=27,d=13,e=38,f=40;a.fn.scrollTo=function(b,c){return a(this).stop().animate({scrollTop:a(this).scrollTop()-a(this).offset().top+a(b).offset().top-10},void 0==c?1e3:c),this};var g={courseid:"",keys:[]},h=function(a){var b,c;for(b in g)g.hasOwnProperty(b)&&a.hasOwnProperty(b)&&(c=typeof g[b],"boolean"===c?g[b]=Boolean(a[b]):"number"===c?g[b]=Number(a[b]):"string"===c?g[b]=String(a[b]):g[b]=a[b])},i={$mainModal:!1,$mainModalBackLayer:!1,$mainModalCommand:!1,$liSet:!1,isShow:!1,json:"",log:function(){try{console.log.apply(console,arguments)}catch(a){throw a}},render:function(){var b=0;i.log("render UI"),a("body").append('<div id="local_commander_modal" class="local_commander"><div class="local_commander-header"><h2>'+M.util.get_string("js:header","local_commander")+'</h2></div><div class="local_commander-body"></div><input type="text" name="local_commander_command" id="local_commander_command" placeholder="'+M.util.get_string("js:command_placeholder","local_commander")+'"></div><div id="local_commander_back_layer"></div>'),i.$mainModal=a("#local_commander_modal"),i.$mainModalBackLayer=a("#local_commander_back_layer"),i.$mainModalCommand=a("#local_commander_command"),i.setHeight(),i.$mainModalBackLayer.on("click",function(){i.hide()}),i.$mainModalCommand.on("keydown",function(a){var g=a.keyCode||a.which;switch(i.log("Code pressed:",g),g){case c:case d:case e:case f:return}i.log("Searching"),clearTimeout(b),b=setTimeout(function(){i.search(i.$mainModalCommand.val())},100)}),""===i.json&&i.loadMenu()},start:function(){i.$mainModal=a("#local_commander_modal"),a(window).on("keydown",function(a){var b=a.keyCode||a.which;if(i.log("Code pressed:",b),i.log("Show:",i.isShow),i.isShow)switch(b){case c:i.hide();break;case d:a.preventDefault(),i.goToCommand();break;case e:a.preventDefault(),i.arrowUp();break;case f:a.preventDefault(),i.arrowDown()}else if(g.keys.indexOf(b.toString())!==-1){if(i.log("Commander keyboard key triggered"),"INPUT"==a.target.tagName||"SELECT"==a.target.tagName||"TEXTAREA"==a.target.tagName||a.target.isContentEditable)return void i.log("Hide when we are in an editable element");a.preventDefault(),0==i.$mainModal.length&&i.render(),i.log("Open commander."),i.isShow?i.hide():i.show()}})},highlightWord:function(a,b){if(3==a.nodeType){var c=a.data.toUpperCase().indexOf(b);if(c>=0){var d=document.createElement("span");d.className="highlight",d.style.backgroundColor="#f4bd21";var e=a.splitText(c),f=e.cloneNode(!0);d.appendChild(f),e.parentNode.replaceChild(d,e)}}else if(1==a.nodeType&&a.childNodes)for(var g=0;g<a.childNodes.length;++g)g+=i.highlightWord(a.childNodes[g],b)},arrowUp:function(){i.log("arrowUp");var b=a("#local_commander_modal ul li.active"),c=b.closest("li").prevAll("li:visible").eq(0);b.length&&b.removeClass("active"),c.length?c.addClass("active"):b.addClass("active"),i.scrollTo()},arrowDown:function(){i.log("arrowDown");var b=a("#local_commander_modal ul li.active"),c=b.closest("li").nextAll("li:visible").eq(0);b.length&&b.removeClass("active"),c.length?c.addClass("active"):a("#local_commander_modal ul li:visible").last().addClass("active"),i.scrollTo()},scrollTo:function(){a("#local_commander_modal .local_commander-body div").scrollTo("#local_commander_modal li.active",200)},goToCommand:function(){i.log("goToCommand");var b=a("#local_commander_modal ul li.active a");if(b){var c=b.attr("href");"#"!=c&&(window.location=c)}},loadMenu:function(){a.ajax({url:M.cfg.wwwroot+"/local/commander/ajax.php",method:"GET",data:{courseid:g.courseid},dataType:"json"}).done(function(a){i.log(a),i.json=a,i.setMenu(),i.setHeight()}).fail(function(){b.alert("js:error_parsing","local_commander")})},search:function(b){a(".local_commander-body ul li").show(),i.$liSet.find("li.active").removeClass("active"),i.$liSet.find("span.highlight").each(function(){i.removeHighlight(this.parentNode)}),""!==b&&(i.$liSet.children().each(function(){i.highlightWord(this,b.toUpperCase())}),a(".local_commander-body span.highlight").first().parent().parent().addClass("active"),a(".local_commander-body ul li:not(:has(span))").hide())},setMenu:function(){i.log("setMenu() ");var b="<div><ul>";g.courseid>0&&(i.log("Has course param."),b+=i.renderMenuItems(i.json.courseadmin,1)),b+=i.renderMenuItems(i.json.admin,1),b+="</ul></div>",i.$mainModal.find(".local_commander-body").append(b),i.$liSet=a(".local_commander-body ul")},renderMenuItems:function(b,c,d){var e="";return b.name?(d?d+=" &rarr; ":d="",e+="<li>",b.name&&(e+='<a href="'+b.link+'">'+d+b.name+"</a>"),b.haschildren&&a.each(b.children,function(a,f){e+=i.renderMenuItems(f,c+1,d+b.name)}),e+="</li>"):e},show:function(){i.$mainModal.show(),i.$mainModalBackLayer.show(),i.isShow=!0,i.$mainModalCommand.focus()},hide:function(){i.$mainModal.hide(),i.$mainModalBackLayer.hide(),i.isShow=!1},setHeight:function(){var b=Math.round(a(window).height()/2);i.$mainModal.height(b),a(".local_commander-body div").height(b-100)},removeHighlight:function(b){a(b).html(a(b).text())}};return{init:function(b){h(b),a(document).ready(function(){i.log("ready() - local commander v3.81",g),i.start()})}}});