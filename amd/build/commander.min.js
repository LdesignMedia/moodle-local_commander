define("local_commander/commander",["exports","core/notification","core/log"],(function(_exports,_notification,_log){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_notification=_interopRequireDefault(_notification),_log=_interopRequireDefault(_log);const ESCAPE=27,ENTER=13,ARROWUP=38,ARROWDOWN=40,commanderAppOptions={courseid:"",keys:[]};const commanderApp={mainModal:null,mainModalBackLayer:null,mainModalCommand:null,liSet:null,isShow:!1,json:"",render(){let timer=0;_log.default.debug("Rendering UI");const modalHtml='\n            <div id="local_commander_modal" class="local_commander">\n                <div class="local_commander-header">\n                    <h2>'.concat(M.util.get_string("js:header","local_commander"),'</h2>\n                </div>\n                <div class="local_commander-body">\n                    <div><ul></ul></div>\n                </div>\n                <input type="text" name="local_commander_command" id="local_commander_command"\n                 placeholder="').concat(M.util.get_string("js:command_placeholder","local_commander"),'">\n            </div>\n            <div id="local_commander_back_layer"></div>\n        ');document.body.insertAdjacentHTML("beforeend",modalHtml),this.mainModal=document.getElementById("local_commander_modal"),this.mainModalBackLayer=document.getElementById("local_commander_back_layer"),this.mainModalCommand=document.getElementById("local_commander_command"),this.setHeight(),this.mainModalBackLayer.addEventListener("click",(()=>{this.hide()})),this.mainModalCommand.addEventListener("keydown",(e=>{const keyboardCode=e.keyCode||e.which;_log.default.debug("Code pressed: ".concat(keyboardCode)),[ESCAPE,ENTER,ARROWUP,ARROWDOWN].includes(keyboardCode)||(_log.default.debug("Searching"),clearTimeout(timer),timer=setTimeout((()=>{this.search(this.mainModalCommand.value)}),100))})),""===this.json&&this.loadMenu()},start(){window.addEventListener("keydown",(e=>{const keyboardCode=e.keyCode||e.which;if(_log.default.debug("Code pressed: ".concat(keyboardCode)),_log.default.debug("Trigger keys: ".concat(commanderAppOptions.keys)),_log.default.debug("Commander is visible: ".concat(this.isShow)),this.isShow)switch(keyboardCode){case ESCAPE:this.hide();break;case ENTER:e.preventDefault(),this.goToCommand();break;case ARROWUP:e.preventDefault(),this.arrowUp();break;case ARROWDOWN:e.preventDefault(),this.arrowDown()}else if(commanderAppOptions.keys.includes(keyboardCode.toString())){_log.default.debug("Commander keyboard key triggered");const target=e.target,tagName=target.tagName.toUpperCase();if(["INPUT","SELECT","TEXTAREA"].includes(tagName)||target.isContentEditable)return void _log.default.debug("Ignoring keypress in editable element");e.preventDefault(),this.mainModal||this.render(),_log.default.debug("Opening commander"),this.isShow?this.hide():this.show()}}))},highlightWord(node,word){if(node.nodeType===Node.TEXT_NODE){const pos=node.data.toUpperCase().indexOf(word);if(pos>=0){const spannode=document.createElement("span");spannode.className="highlight";const middlebit=node.splitText(pos);middlebit.splitText(word.length);const middleclone=middlebit.cloneNode(!0);spannode.appendChild(middleclone),middlebit.parentNode.replaceChild(spannode,middlebit)}}else node.nodeType===Node.ELEMENT_NODE&&node.childNodes&&!["SCRIPT","STYLE"].includes(node.tagName)&&node.childNodes.forEach((child=>{this.highlightWord(child,word)}))},arrowUp(){_log.default.debug("Navigating up");const activeItem=this.mainModal.querySelector("ul li.active");let prevItem=null;if(activeItem)for(activeItem.classList.remove("active"),prevItem=activeItem.previousElementSibling;prevItem&&"none"===prevItem.style.display;)prevItem=prevItem.previousElementSibling;prevItem?prevItem.classList.add("active"):activeItem&&activeItem.classList.add("active"),this.scrollToActiveItem()},arrowDown(){_log.default.debug("Navigating down");const activeItem=this.mainModal.querySelector("ul li.active");let nextItem=null;if(activeItem)for(activeItem.classList.remove("active"),nextItem=activeItem.nextElementSibling;nextItem&&"none"===nextItem.style.display;)nextItem=nextItem.nextElementSibling;if(nextItem)nextItem.classList.add("active");else{const lastVisibleItem=Array.from(this.mainModal.querySelectorAll("ul li")).reverse().find((item=>"none"!==item.style.display));lastVisibleItem&&lastVisibleItem.classList.add("active")}this.scrollToActiveItem()},scrollToActiveItem(){const container=this.mainModal.querySelector(".local_commander-body div"),activeItem=this.mainModal.querySelector("li.active");activeItem&&container&&(container.scrollTop=activeItem.offsetTop-container.offsetTop-10)},goToCommand(){_log.default.debug("Executing command");const activeLink=this.mainModal.querySelector("ul li.active a");if(activeLink){const link=activeLink.getAttribute("href");"#"!==link&&(window.location.href=link)}},loadMenu(){fetch("".concat(M.cfg.wwwroot,"/local/commander/ajax.php?courseid=").concat(commanderAppOptions.courseid),{method:"GET",credentials:"same-origin"}).then((response=>response.json())).then((data=>{_log.default.debug(data),this.json=data,this.setMenu(),this.setHeight()})).catch((()=>{_notification.default.alert("js:error_parsing","local_commander")}))},search(word){const listItems=this.mainModal.querySelectorAll(".local_commander-body ul li");listItems.forEach((li=>{li.style.display="",li.classList.remove("active")}));if(this.mainModal.querySelectorAll(".highlight").forEach((span=>{this.removeHighlight(span.parentNode)})),""!==word){const wordUpper=word.toUpperCase();let firstHighlighted=null;this.liSet.forEach((li=>{this.highlightWord(li,wordUpper),!firstHighlighted&&li.querySelector(".highlight")&&(firstHighlighted=li)})),firstHighlighted&&firstHighlighted.classList.add("active"),listItems.forEach((li=>{li.querySelector(".highlight")||(li.style.display="none")}))}},setMenu(){_log.default.debug("Setting up menu");let html="";commanderAppOptions.courseid>0&&(_log.default.debug("Including course administration menu"),html+=this.renderMenuItems(this.json.courseadmin,"")),html+=this.renderMenuItems(this.json.admin,"");this.mainModal.querySelector(".local_commander-body ul").innerHTML=html,this.liSet=this.mainModal.querySelectorAll(".local_commander-body ul li")},renderMenuItems(item,parentName){if(!item.name)return"";let html="";const fullName=parentName?"".concat(parentName," â†’ ").concat(item.name):item.name;return html+='<li><a href="'.concat(item.link,'">').concat(fullName,"</a></li>"),item.haschildren&&item.children.forEach((child=>{html+=this.renderMenuItems(child,fullName)})),html},show(){this.mainModal.style.display="block",this.mainModalBackLayer.style.display="block",this.isShow=!0,this.mainModalCommand.focus()},hide(){this.mainModal.style.display="none",this.mainModalBackLayer.style.display="none",this.isShow=!1},setHeight(){const height=Math.round(window.innerHeight/2);this.mainModal.style.height="".concat(height,"px");const bodyDiv=this.mainModal.querySelector(".local_commander-body div");bodyDiv&&(bodyDiv.style.height="".concat(height-100,"px"))},removeHighlight(node){node.innerHTML=node.textContent}};var _default={init:function(params){var options;options=params,Object.keys(commanderAppOptions).forEach((key=>{if(options.hasOwnProperty(key)){const vartype=typeof commanderAppOptions[key];commanderAppOptions[key]="boolean"===vartype?Boolean(options[key]):"number"===vartype?Number(options[key]):"string"===vartype?String(options[key]):options[key]}})),document.addEventListener("DOMContentLoaded",(()=>{_log.default.debug("DOM fully loaded - initializing commanderApp"),_log.default.debug(commanderAppOptions),commanderApp.start()}))}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=commander.min.js.map