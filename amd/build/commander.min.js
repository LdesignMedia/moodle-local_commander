define(["jquery","core/notification"],function(a,b){"use strict";a.fn.scrollTo=function(b,c){return a(this).stop().animate({scrollTop:a(this).scrollTop()-a(this).offset().top+a(b).offset().top-10},void 0==c?1e3:c),this};var c={courseid:"",key1:192},d=function(a){var b,d;for(b in c)c.hasOwnProperty(b)&&a.hasOwnProperty(b)&&(d=typeof c[b],"boolean"===d?c[b]=Boolean(a[b]):"number"===d?c[b]=Number(a[b]):"string"===d&&(c[b]=String(a[b])))},e={$mainModal:!1,$mainModalBackLayer:!1,$mainModalCommand:!1,$liSet:!1,isShow:!1,json:"",log:function(){try{console.log.apply(console,arguments)}catch(a){throw a}},render:function(){var b=0;e.log("render UI"),a("body").append('<div id="local_commander_modal" class="local_commander"><div class="local_commander-header"><h2>'+M.util.get_string("js:header","local_commander")+'</h2></div><div class="local_commander-body"></div><input type="text" name="local_commander_command" id="local_commander_command" placeholder="'+M.util.get_string("js:command_placeholder","local_commander")+'"></div><div id="local_commander_back_layer"></div>'),e.$mainModal=a("#local_commander_modal"),e.$mainModalBackLayer=a("#local_commander_back_layer"),e.$mainModalCommand=a("#local_commander_command"),e.setHeight(),e.$mainModalBackLayer.on("click",function(){e.hide()}),e.$mainModalCommand.on("keydown",function(a){return 13==a.keyCode||38==a.keyCode||40==a.keyCode||c.key1==a.keyCode?void a.preventDefault():27===a.keyCode?void e.hide():(clearTimeout(b),void(b=setTimeout(function(){e.search(e.$mainModalCommand.val())},100)))}),e.$mainModalCommand.on("keypress",function(a){var b=a.charCode||a.keyCode;return c.key1!=b}),""===e.json&&e.loadMenu()},start:function(){e.$mainModal=a("#local_commander_modal"),a(document).on("keydown",function(a){e.isShow&&(13==a.keyCode?(a.preventDefault(),e.goToCommand()):38==a.keyCode?(a.preventDefault(),e.arrowUp()):40==a.keyCode&&(a.preventDefault(),e.arrowDown())),a.keyCode==c.key1&&(a.preventDefault(),0==e.$mainModal.length&&e.render(),e.log("Open commander."),e.isShow?e.hide():e.show())})},highlightWord:function(a,b){if(3==a.nodeType){var c=a.data.toUpperCase().indexOf(b);if(c>=0){var d=document.createElement("span");d.className="highlight",d.style.backgroundColor="#f4bd21";var f=a.splitText(c),g=f.cloneNode(!0);d.appendChild(g),f.parentNode.replaceChild(d,f)}}else if(1==a.nodeType&&a.childNodes)for(var h=0;h<a.childNodes.length;++h)h+=e.highlightWord(a.childNodes[h],b)},arrowUp:function(){e.log("arrowUp");var b=a("#local_commander_modal ul li.active"),c=b.closest("li").prevAll("li:visible").eq(0);b.length&&b.removeClass("active"),c.length?c.addClass("active"):b.addClass("active"),e.scrollTo()},arrowDown:function(){e.log("arrowDown");var b=a("#local_commander_modal ul li.active"),c=b.closest("li").nextAll("li:visible").eq(0);b.length&&b.removeClass("active"),c.length?c.addClass("active"):a("#local_commander_modal ul li:visible").last().addClass("active"),e.scrollTo()},scrollTo:function(){a("#local_commander_modal .local_commander-body div").scrollTo("#local_commander_modal ul li.active",200)},goToCommand:function(){e.log("goToCommand");var b=a("#local_commander_modal ul li.active a");if(b){var c=b.attr("href");"#"!=c&&(window.location=c)}},loadMenu:function(){a.ajax({url:M.cfg.wwwroot+"/local/commander/ajax.php",method:"GET",data:{courseid:c.courseid},dataType:"json"}).done(function(a){e.log(a),e.json=a,e.setMenu(),e.setHeight()}).fail(function(){b.alert("js:error_parsing","local_commander")})},search:function(b){a(".local_commander-body ul li").show(),e.$liSet.find("li.active").removeClass("active"),e.$liSet.find("span.highlight").each(function(){e.removeHighlight(this.parentNode)}),""!=b&&(e.$liSet.children().each(function(){e.highlightWord(this,b.toUpperCase())}),a(".local_commander-body span.highlight").first().parent().parent().addClass("active"),a(".local_commander-body ul li:not(:has(span))").hide())},setMenu:function(){e.log("setMenu() ");var b="<div><ul>";c.courseid>0&&(e.log("Has course param."),b+=e.renderMenuItems(e.json.courseadmin,1)),b+=e.renderMenuItems(e.json.admin,1),b+="</ul></div>",e.$mainModal.find(".local_commander-body").append(b),e.$liSet=a(".local_commander-body ul")},renderMenuItems:function(b,c,d){var f="";return b.name?(d?d+=" &rarr; ":d="",f+="<li>",b.name&&(f+='<a href="'+b.link+'">'+d+b.name+"</a>"),b.haschildren&&a.each(b.children,function(a,g){f+=e.renderMenuItems(g,c+1,d+b.name)}),f+="</li>"):f},show:function(){e.$mainModal.show(),e.$mainModalBackLayer.show(),e.isShow=!0,e.$mainModalCommand.focus()},hide:function(){e.$mainModal.hide(),e.$mainModalBackLayer.hide(),e.isShow=!1},setHeight:function(){var b=Math.round(a(window).height()/2);e.$mainModal.height(b),a(".local_commander-body div").height(b-100)},removeHighlight:function(b){a(b).html(a(b).text())}};return{init:function(b){d(b),a(document).ready(function(){e.log("ready() - local commander v1.25",c),e.start()})}}});