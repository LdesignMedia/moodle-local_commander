define(["jquery","core/notification"],function(d,o){"use strict";d.fn.scrollTo=function(o,e){return d(this).stop().animate({scrollTop:d(this).scrollTop()-d(this).offset().top+d(o).offset().top-10},null==e?1e3:e),this};var n={courseid:"",key1:192},r={$mainModal:!1,$mainModalBackLayer:!1,$mainModalCommand:!1,$liSet:!1,isShow:!1,json:"",log:function(){try{console.log.apply(console,arguments)}catch(o){throw o}},render:function(){var e=0;r.log("render UI"),d("body").append('<div id="local_commander_modal" class="local_commander"><div class="local_commander-header"><h2>'+M.util.get_string("js:header","local_commander")+'</h2></div><div class="local_commander-body"></div><input type="text" name="local_commander_command" id="local_commander_command" placeholder="'+M.util.get_string("js:command_placeholder","local_commander")+'"></div><div id="local_commander_back_layer"></div>'),r.$mainModal=d("#local_commander_modal"),r.$mainModalBackLayer=d("#local_commander_back_layer"),r.$mainModalCommand=d("#local_commander_command"),r.setHeight(),r.$mainModalBackLayer.on("click",function(){r.hide()}),r.$mainModalCommand.on("keydown",function(o){13!=o.keyCode&&38!=o.keyCode&&40!=o.keyCode&&n.key1!=o.keyCode?27!==o.keyCode?(clearTimeout(e),e=setTimeout(function(){r.search(r.$mainModalCommand.val())},100)):r.hide():o.preventDefault()}),r.$mainModalCommand.on("keypress",function(o){var e=o.charCode||o.keyCode;return n.key1!=e}),""===r.json&&r.loadMenu()},start:function(){r.$mainModal=d("#local_commander_modal"),d(document).on("keydown",function(o){r.isShow&&(13==o.keyCode?(o.preventDefault(),r.goToCommand()):38==o.keyCode?(o.preventDefault(),r.arrowUp()):40==o.keyCode&&(o.preventDefault(),r.arrowDown())),o.keyCode==n.key1&&(o.preventDefault(),0==r.$mainModal.length&&r.render(),r.log("Open commander."),r.isShow?r.hide():r.show())})},highlightWord:function(o,e){if(3==o.nodeType){var a=o.data.toUpperCase().indexOf(e);if(0<=a){var n=document.createElement("span");n.className="highlight",n.style.backgroundColor="#f4bd21";var l=o.splitText(a),i=(l.splitText(e.length),l.cloneNode(!0));n.appendChild(i),l.parentNode.replaceChild(n,l)}}else if(1==o.nodeType&&o.childNodes)for(var d=0;d<o.childNodes.length;++d)d+=r.highlightWord(o.childNodes[d],e)},arrowUp:function(){r.log("arrowUp"),d("#local_commander_modal ul li.active").removeClass("active").addClass("active"),r.scrollTo()},arrowDown:function(){r.log("arrowDown"),d("#local_commander_modal ul li.active").removeClass("active").next().addClass("active"),r.scrollTo()},scrollTo:function(){d("#local_commander_modal .local_commander-body div").scrollTo("#local_commander_modal ul li.active",200)},goToCommand:function(){r.log("goToCommand");var o=d("#local_commander_modal ul li.active a");if(o){var e=o.attr("href");"#"!=e&&(window.location=e)}},loadMenu:function(){d.ajax({url:M.cfg.wwwroot+"/local/commander/ajax.php",method:"GET",data:{courseid:n.courseid},dataType:"json"}).done(function(o){r.log(o),r.json=o,r.setMenu()}).fail(function(){o.alert("js:error_parsing","local_commander")})},search:function(o){d(".local_commander-body ul li").show(),r.$liSet.find("li.active").removeClass("active"),r.$liSet.find("span.highlight").each(function(){var o=this.parentNode;o.replaceChild(this.firstChild,this),r.removeHighlight(o)}).end(),""!=o&&(r.$liSet.children().each(function(){r.highlightWord(this,o.toUpperCase())}),d("span.highlight").first().parent().parent().addClass("active"),d(".local_commander-body ul li:not(:has(span))").hide())},setMenu:function(){r.log("setMenu() ");var o="<div><ul>";0<n.courseid&&(r.log("Has course param."),o+=r.renderMenuItems(r.json.courseadmin,1)),o+=r.renderMenuItems(r.json.admin,1),o+="</ul></div>",r.$mainModal.find(".local_commander-body").append(o),r.$liSet=d(".local_commander-body ul")},renderMenuItems:function(a,n,l){var i="";return a.name?(l?l+=" &rarr; ":l="",i+="<li>",a.name&&(i+='<a href="'+a.link+'">'+l+a.name+"</a>"),a.haschildren&&d.each(a.children,function(o,e){i+=r.renderMenuItems(e,n+1,l+a.name)}),i+="</li>"):i},show:function(){r.$mainModal.show(),r.$mainModalBackLayer.show(),r.isShow=!0,r.setHeight(),r.$mainModalCommand.focus()},hide:function(){r.$mainModal.hide(),r.$mainModalBackLayer.hide(),r.isShow=!1},setHeight:function(){r.$mainModal.css({height:d(window).height()/2})},removeHighlight:function(o){d(o).html(d(o).text())}};return{init:function(o){!function(o){var e,a;for(e in n)n.hasOwnProperty(e)&&o.hasOwnProperty(e)&&("boolean"==(a=typeof n[e])?n[e]=Boolean(o[e]):"number"===a?n[e]=Number(o[e]):"string"===a&&(n[e]=String(o[e])))}(o),d(document).ready(function(){r.log("ready() - local commander v1.25",n),r.start()})}}});